+++
weight = "20"
type = "post"
draft = false
sidebar = true
date = 2014-03-04T07:56:39Z
title = "Hosting on IOOS GitHub Pages Workflow"

+++

# Introduction

This document describes the deployment of the IOOS documentation web pages generated with a [_**Hugo**_](http://gohugo.io/) static page generator. The _**Hugo**_ generator was picked out after some research and experiments mostly for the following reasons:

 * portability, i.e. it is a self-contained application that does not require installation; 
 * no prerequisite installation of a tool/language like Ruby, Python, or Java;
 * direct processing of the Markdown content;  
 * very satisfactory results with a bare minimal modification of the default themes and templates;
 * relatively simple workflow of the generated web site deployment onto GitHub Pages.

The following workflow description is mostly based on the [Hosting on GitHub Pages](http://gohugo.io/tutorials/github_pages_blog/) tutorial, which has been updated to reflect IOOS specifics.  

# IOOS Documentation Repositories

The IOOS DMAC Documentation Strategy requires that all DMAC-related documentation is converted into Markdown, and stored in a specially structured GitHub repository. In general, the repository must contain a "doc" directory that holds all documents in Markdown, and a "README.md" file that briefly describes the repository:

```
   ioos/[some repository]/
    ├── doc/
    |    ├── DOC1.md
    |    ├── DOC2.md
    |    |    └── images/
    |    └── DOC3.md  
    └── README.md
```     
In some cases the repository may have more complex structure, and contain not only Markdown files; for example, the [sos-guidelines](https://github.com/ioos/sos-guidelines) repository includes an additional SOS Templates section with a set of XML files: 

```
   ioos/sos-guidelines/
    ├── doc/
    |    ├── testing/
    |    |    └── sos_test_list_github_notoc_summary.md
    |    └── wsdd/ 
    |         ├── sos_wsdd_github_notoc.md    
    |         └── sos_wsdd_github_toc.md
    ├── template/
    |    └── milestone 1.0/
    |          ├── OM-GetObservation.xml
    |          ├── SML-DescribeSensor-Network.xml
    |          ├── SML-DescribeSensor-Station.xml
    |          ├── SOS-GetCapabilities.xml
    |          ├── SWE-MultiStation-TimeSeries.xml
    |          ├── SWE-MultiStation-TimeSeries_QC.xml
    |          ├── SWE-SingleStation-SingleProperty-TimeSeries.xml
    |          ├── SWE-SingleStation-TimeSeriesProfile.xml
    |          └── SWE-SingleStation-TimeSeriesProfile_QC.xml
    └── README.md
```     

# Structure of IOOS Documentation Website

By default, _**Hugo**_ expects the content of the site to be structured in some specific way, and uses that same structure to render the website. 

The top level of a source directory will typically have the following elements:

```
   ioos/[some-repository-name]/
    ├── archtypes/
    ├── content/
    ├── layouts/
    ├── static/
    └── config file
```     

The `content` directory by default holds the documents that are the actual content of the website (i.e. are rendered by _**Hugo**_), and sub-directories of the `content` directory form the sections. The real content holding directory may be changed with a _contentdir_ value in the _**Hugo**_ [config file](http://gohugo.io/overview/configuration/). 

The `static` directory is used to hold the common website elements, such as Style Sheets, Java Scripts, and images, etc., which will be copied directly into the final site when rendered. Although _**Hugo**_ does not require any specific structure for `static` directory, it is usually organized in the following way:

```
   static/
    ├── css/
    ├── js/
    └── images/
``` 

_**NOTES**_:

>1. Currently, _**Hugo**_ can render only Markdown files, so all documents in the `contentdir` (e.g. 'content') must be in Markdown format for proper rendering. As the original documents may be in various formats, it is necessary to keep the `contentdir` separate from the original document directory (e.g. 'doc').    
>2. All images and diagrams from the original documents that should appear on the rendered web pages must be copied into the _**static/images**_ directory for the proper website rendering.  The links to the images in the Markdown version of the document have to be modified accordingly.      
>
 


## Site Config File

The config file defines the framework of the website generated by _**Hugo**_. It defines site-wide settings (like the websites `baseurl`), and allows to modify to some extent the default website structure. For example, the `sos-guidelines` website has file `config.toml` with the following contents

```
baseurl = "http://abirger.github.io/sos-guidelines"
CanonifyUrls = true
contentdir = "content"
layoutdir = "layouts"
publishdir = "public"
languageCode = "en-us"
[params]
    Title = "IOOS SOS Guidelines"
    Tagline = "Docs, codes, scripts, templates"
[params.Github]
    Head = "master"
    Url = "https://github.com/ioos/sos-guidelines"
```

For detailed explanation of how to build the _**Hugo**_ config file, and the exact meaning of the parameters and operators refer to the [Configuration](http://gohugo.io/overview/configuration) section of _**Hugo**_ documentation.


## HTML Templates 

For IOOS DMAC documentation web pages, the [_**Lanyon**_](https://github.com/tummychow/lanyon-hugo) theme has been chosen because it has a sliding sidebar controlled by an unobtrusive clickable button, which allows using almost all available screen space for large documents like XML listings and such. The default theme was slightly modified in order to increase its expressiveness, add IOOS logo, and further expand the document viewing area.
     
_**NOTES:**_

>1. The _**Hugo**_ requires that the home page should be defined as the `index.html` file in the `layouts` directory. 
>2. To show the documents' summary on the website home page, each document in `contentdir` directory has to start from the summary text separated from the rest of the document with the line that contains the \<!--more--\> comment.
>3. If the home page should contain just a single document (e.g. about the site), that document must have a `url = "index.html"` line in the [front matter](#toc_5).
>3. The IOOS logo is in the 'ioos_blue2.png' file located in 'static/images/' directory.

For a detailed description of the _**Hugo**_ themes, templates and layouts refer to the [_**Hugo**_ documentation](http://gohugo.io/).

## Hugo Metadata in Content Files

To ensure a proper rendering of the website content, each document in the `contentdir` should include at the top a metadata section. That metadata section is called a [front matter](http://gohugo.io/content/front-matter/), and should be written in YAML, TOML or JSON format. The front matter tells _**Hugo**_ some details of how to render the content file. For example, the following front matter is included in the SOS WSDD file:

```
+++
draft = false
title = "IOOS SOS v1.0 WSDD"
description = "IOOS SOS v1.0 Web Service Description"
type = "post"
sidebar = true
date = 2014-08-04T08:09:56Z
weight = "1"
+++
```

In the following example of the front matter, the line `url = "index.html"` instructs _**Hugo**_ that this file should be rendered as a home page: 

```
+++
weight = "0"
type = "post"
draft = false
sidebar = true
Title = "ABOUT: Biological Data Enrollment Process"
date = 2014-08-04T07:56:39Z
url = "index.html"
+++
```

For a detailed description of the metadata section supported formats and variables refer to the  _**Hugo**_ [Front Matter](http://gohugo.io/content/front-matter/) documentation.


### Content and Non-content Menu in Sidebar 

By default, _**Hugo**_ will put the document title into sidebar document menu. That behavior can be changed with the `sidebar = false` line in the front matter. 

Apart from the content menu entries, the sidebar menu may contain entries that aren’t attached to any document in `contentdir`. This takes place in the sitewide config file. For example, to add the menu item that links to the video from a Webinar that is hosted somewhere else, the following lines must be added to the sitewide config file (`name` and `url` are mandatory while `weight` and `identifier` are optional):

```
[[menu.extramedia]]
    name = "Webinar: IOOS Biological Data Enrollment Process (video)"
    url = "https://mmancusa.webex.com/mmancusa/ldr.php?RCID=a08a97a20c0328828c0bc2f4e07f0fa2"
    weight = -110
    identifier = "video"
```

_**NOTE:**_

>The original templates from [_**Lanyon**_](https://github.com/tummychow/lanyon-hugo) theme have been modified to allow adding items to the `extramedia` menu. Adding other non-content menus will require further modification of the `.\layouts\partial\sidebar.html` template. 

For more detailed information on menus definition, refer to a [corresponding part](http://gohugo.io/extras/menus/) of _**Hugo**_ documentation. 


# Workflow for IOOS Documentation Website deployment on GitHub

The  _**Hugo**_ IOOS DMAC Documentation website can be created from any GitHub documentation repository by following a few simple procedures below. 

## Create and Debug a Hugo Site

1. Clone the repository from `github.com/IOOS`, or create the repository in the local directory.
2. Copy the files from IOOS Hugo Skeleton into the local repository directory.
3. Copy or move the Markdown files into `./content` directory, and all images into `.static/images` directory.
4. Edit the `./config.toml` file as needed to fit the project. Set up `baseurl = "http://ioos.github.io/repository-name"`.
5. Add front matter to each Markdown document in the `./content` directory, and edit documents as needed.
6. Edit `./layouts/index.html` template and other templates in `./layouts` directory as needed to fit the project.
7. Edit the `./README.md` file as needed to fit the project.
8. Run _**Hugo**_ with options in the local repository root directory: **`hugo server --watch`**
9. Repeat steps 5 to 7 as needed to produce the satisfactory looking website.

The command _**hugo server --watch**_ starts a web server available at "**http://localhost:1313/repository-name/**", generates website content in the `./public` directory,  watches source files for changes, recreates the web content as needed, and automatically reload any open pages in browser. After the website development and debugging is completed, the final version of the site should be deployed on GitHub Pages. 


## Deploy with a Git Subtree Mirroring

GitHub Pages will serve up a website for any repository that has a branch called `gh-pages` with a valid `index.html` file at that branch's root. To keep an adequate separation between the `master` and `gh-pages` branches, and at the same time make a deployment process visual and simple, the developers of _**Hugo**_ suggested a workflow that is based on use of the `git subtree` family of commands. It allows to mirror the entire `public` directory (which contains the generated website) into the root of the `gh-pages` branch of the repository. As a result, all content modification can be done on the `master` branch, and after _**Hugo**_ has generated the site output into the `public` directory it can be pushed directly to the correct place for GitHub Pages to serve the website. _**Hugo**_  ["_Hosting on GitHub Pages_"](http://gohugo.io/tutorials/github_pages_blog/) tutorial provides a detailed step-by-step description, and the following is a condensed and adapted to the IOOS case version of that workflow: 

```
    1. Create a new orphand branch (no commit history) named gh-pages
         git checkout --orphan gh-pages

    2. Unstage all files
        git rm --cached $(git ls-files)

    3. Grab one file from the master branch so we can make a commit
        git checkout master README.md

    4. Add and commit that file
        git add README.md
        git commit -m "INIT: initial commit on gh-pages branch"

    5. Push to remote gh-pages branch 
        git push origin gh-pages

    6. Return to master branch
        git checkout master

    7. Remove the public folder to make room for the gh-pages subtree
        rm -rf public        

    8. Add the gh-pages branch of the repository. It will look like a folder named public
        git subtree add --prefix public git@github.com:[some-repository-name].git gh-pages --squash

    9. Pull down the file we just committed (totally optional step but helps avoid merge conflicts)
        git subtree pull --prefix=public

    10. Run Hugo. Generated site will be placed in public directory
         hugo

    11. Add everything
         git add -A

    12. Commit and push to master
         git commit -m "Updating site" 
         git push origin master

     13. Push the public subtree to the gh-pages branch
          git subtree push --prefix=public git@github.com:[some-repository-name].git gh-pages
```

After initial deployment, any update of the website would include steps 10 through 13 apart from the creation/update of the content and verification of the generated website. These 4 steps are the same every time content is added or modified. It would be much easier, if that repetitive process is automated with some sort of script. A couple of Linux Bash scripts was developed by Dana Woodman for the [Chimer Arta & Maker Space](https://github.com/chimera/chimeraarts.org) website to automate [preview](https://github.com/chimera/chimeraarts.org/blob/master/preview) and [publish](https://github.com/chimera/chimeraarts.org/blob/master/publish) processes. The latter script was then adopted by Spencer Lyon, and modified into [`deploy.sh`](https://github.com/spencerlyon2/hugo_gh_blog/blob/master/deploy.sh). That script allows to replace the last four items from the above workflow list with a single command `bash deploy.sh`. 

_**NOTES:**_

>1. The workflow was developed for Linux. On Windows, some command either have to be modified (e.g. `rm -rf` to `rmdir c:\test /s /q`), or Linux native commands can be used with the Linux [CoreUtils](http://gnuwin32.sourceforge.net/packages.html) installed.
>2. To allow running Bash scripts on Windows, some Bash shell software for Windows has to be installed. For example, Bash shell is included into a standard [GitHub for windows](https://windows.github.com/) installation package.
>3. All `git` commands have to be run from the site `<root>` directory, i.e. the directory, where the `content` (or another directory defined as `contentdir`) and `layout` sub-directories are located). 
>4. The `[some-repository-name]` has to be changed to the real repository GitHub address, e.g. `ioos/sos-guidelines`. 

## Deploy with an Uncluttered Alternate Approach

The above workflow works just great, and it had been used for a while for IOOS Git Pages deployment; however, it has a drawback: it requires the generated content of the `publishdir` to be committed to the source (`master`) branch. As a result, the `master` branch becomes cluttered up with the files generated by _**Hugo**_ that are only required on the `gh-pages` branch. 

A [different approach](http://gohugo.io/tutorials/github-pages-blog#toc_9) has been developed recently, which unlike the `git-subtree` one does not require to commit the generated files to the `master` branch. It keeps a linear history on the deploy branch and does not make superfluous commits or deploys when the generated files do not change.

For this approach, the Bash [script](https://github.com/X1011/git-directory-deploy) was developed that renders automatic almost all deployment process: the script takes care of everything apart from generating the website with _**Hugo**_; it can even create the `gh-pages` branch of the repository if it does not exist. Although the script requires some initial configuration, the IOOS documentation GitHub Pages are so simple and highly similar that it can be used for each of them without any modification. From now on, the script `deploy.sh` is included into the IOOS _**Hugo**_ website skeleton set, and can be downloaded from any IOOS documentation repository. 

With this script, the deployment process can be reduced to a few steps:

**1. configuration**

> Edit the following variables within the script as needed to fit the project:
> 
 - `deploy_directory`: root of the tree of files to deploy. For IOOS websites the value is always `public`. 
 - `deploy_branch`: branch to commit files to and push to origin. For projects the value is always `gh-pages`
 - `default_username`, `default_email`: identity to use for git commits if none is set already. Usually no need to set up.
 - `repo`: repository to deploy to (must be readable and writable). If script runs in the `repo` root directory, the variable sets up automatically. 

**2. setup**

> Ensure configuration variables are correct in the script and run 
>
>```
>deploy.sh -s
>```
> Option `-s` or `--setup` makes the script perform one-time setup to prepare the repository for deployments: creates `deploy_branch` (i.e. `gh-pages`, initializes it with the contents of `deploy_directory` (i.e. `public`), and pushes it to remote repository.


**3. run**

> Do the following every time you want to deploy:
> 
>  - check out the `master` branch or commit of the source (useful if somebody else might make changes to the source that you are not aware of). The script will use this commit to generate a message when it makes its own commit on the deploy branch.
>  - generate the files in `deploy_directory` (i.e. `publish`). Just run _**Hugo**_.
>  - make sure no uncommitted changes left in git's index, otherwise the script will abort (it is OK to have uncommitted files in the work tree; the script does not touch the work tree).
>  - make sure you are in the project's root directory
>  - run `deploy.sh` with or without any of the following options:
>    * `-v` or `--verbose` echo commands as they are executed; it is recommended for debugging if something goes wrong;
>    * `-e` or `--allow-empty` allow deployment of an empty `public` directory (by default, the script will abort if `deploy_directory` is empty).


_**NOTES:**_

>1. To allow running `deploy.sh` script on Windows, some Bash shell software for Windows has to be installed. For example, Bash shell is included into a standard [GitHub for windows](https://windows.github.com/) installation package.
>2. The above procedure assumes that the script runs from the site `<root>` directory, i.e. the directory, where the `content` (or another directory defined as `contentdir`) and `layout` sub-directories are located).